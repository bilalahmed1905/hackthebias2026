<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your DoomScroll Wrapped 2025</title>
  <link rel="stylesheet" href="css/wrapper.css">
</head>
<body>
  <div class="wrapper" id="wrapper">
    <!-- Slides dynamically generated here -->
  </div>
  
  <script type="module">
    import videoData from './js/videoData.js';

    // Data structures
    let engagementData = null;
    let feedHistory = null;
    let wrappedStats = {};
    let totalInteractions = 0;

    // Helper functions
    function getRandomVideoByHashtag(hashtag) {
      console.log("hashtag", hashtag);
      const filtered = videoData.filter(v => 
        v.hashtags.includes(hashtag) && !feedHistory.find(seen => seen.videoId === v.videoId)
      );
      if (filtered.length === 0) return null;
      const randomIndex = Math.floor(Math.random() * filtered.length);
      return filtered[randomIndex];
    }

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      loadData();
      if (engagementData && feedHistory) {
        analyzeData();
        renderSlides();
      } else {
        showNoData();
      }
    });
    
    function loadData() {
  try {
    // Load from localStorage - main.js saves as 'userProfile' with structure: { engagement: { tech: 15, funny: 8, ... } }
    const userProfile = JSON.parse(localStorage.getItem('userProfile'));
    const feed = JSON.parse(localStorage.getItem('feedHistory'));
    
    if (userProfile && userProfile.engagement) {
      engagementData = userProfile;  // Extract the engagement object
      console.log('‚úÖ Loaded user profile:', engagementData);
    } else {
      console.log('‚ö†Ô∏è No user profile found in localStorage');
      engagementData = null;
    }
    
    // feedHistory isn't saved by main.js yet, so we'll reconstruct or skip it
    feedHistory = JSON.parse(localStorage.getItem('feedHistory')) || [];
    
    // If no feedHistory, create mock entries (since main.js doesn't save this)
    if (feedHistory.length === 0 && engagementData) {
      console.log('No feed history, using engagement data only');
      feedHistory = []; // We'll work with just engagement data
    }
    
  } catch (error) {
    console.error('Error loading data:', error);
    engagementData = null;
    feedHistory = [];
  }
}

function analyzeData() {
  if (!engagementData) return;
  
  // Calculate total from the engagement scores
  const totalEngagement = Object.values(engagementData).reduce((sum, val) => sum + val, 0);
   totalInteractions = engagementData.interactionCount || 0;  // Get actual click count
  
  // Sort hashtags by engagement score and get top 3
  const sortedHashtags = Object.entries(engagementData)
    .sort((a, b) => b[1] - a[1])
    .slice(0, 3);
  
  console.log('üìä Top 3 hashtags:', sortedHashtags);
  
  const topHashtag = sortedHashtags[0][0];
  const dominantBias = determineBias(sortedHashtags, totalEngagement);
  const diversityScore = calculateDiversity(engagementData);
  const concentration = (sortedHashtags[0][1] / totalEngagement) * 100;
  
  wrappedStats = {
    totalEngagement,
    sortedHashtags,
    topHashtag,
    dominantBias,
    diversityScore,
    concentration,
    videosWatched: feedHistory.length || 20  // Default to 20 if no history
  };
  
  console.log('‚úÖ Analysis complete:', wrappedStats);
}

    function determineBias(hashtags, total) {
      const topPercentage = hashtags[0][1] / total * 100;
      
      if (topPercentage > 70) {
        return {
          name: 'Filter Bubble',
          description: 'The algorithm trapped you in an echo chamber, showing you mostly one type of content. This creates a narrow worldview and reinforces existing preferences.',
          severity: 'high'
        };
      } else if (topPercentage > 50) {
        return {
          name: 'Confirmation Bias',
          description: 'You were fed content that confirmed your interests, making you engage more with similar topics. This reinforces your existing beliefs and preferences.',
          severity: 'medium'
        };
      } else {
        return {
          name: 'Engagement Optimization',
          description: 'The algorithm prioritized keeping you scrolling by showing varied but engaging content, maximizing your time on the platform.',
          severity: 'medium'
        };
      }
    }

    function calculateDiversity(engagement) {
      const values = Object.values(engagement);
      const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
      const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
      const stdDev = Math.sqrt(variance);
      return Math.max(0, Math.min(100, 100 - (stdDev * 10)));
    }

    function renderSlides() {
      const wrapper = document.getElementById('wrapper');
      
      const slides = [
        createWelcomeSlide(),
        createTotalEngagementSlide(),
        createTopHashtagsSlide(),
        createFilterBubbleSlide(),
        createVideoJourneySlide(),
        createFutureSlide(),
        createBiasRevealSlide(),
        createFinalSlide()
      ];
      
      wrapper.innerHTML = slides.join('');
      setupKeyboardNav();
    }

    function createWelcomeSlide() {
      return `
        <div class="slide slide-1">
          <div class="slide-content">
            <h1>Your DoomScroll<br>Wrapped 2026</h1>
            <p class="subtitle">Let's see how the algorithm shaped your feed...</p>
            <div class="scroll-indicator">‚Üì Scroll Down ‚Üì</div>
          </div>
        </div>
      `;
    }

    function createTotalEngagementSlide() {
      return `
        <div class="slide slide-2">
          <div class="slide-content">
            <h2>You interacted with content</h2>
            <div class="stat-large">${totalInteractions}</div>
            <p class="subtitle">times across ${wrappedStats.videosWatched} videos</p>
            <p style="font-size: 1.1rem; opacity: 0.8; margin-top: 20px;">
              Each like, comment, and share taught the algorithm more about you
            </p>
          </div>
        </div>
      `;
    }

    function createTopHashtagsSlide() {
      const hashtagsHTML = wrappedStats.sortedHashtags.map((tag, index) => `
        <div class="hashtag-item">
          <span class="hashtag-name">#${tag[0]}</span>
          <span class="hashtag-score">${tag[1]} points</span>
        </div>
      `).join('');
      
      return `
        <div class="slide slide-3">
          <div class="slide-content">
            <h2>Your Top Topics</h2>
            <div class="hashtag-list">
              ${hashtagsHTML}
            </div>
            <p style="font-size: 1.1rem; opacity: 0.8; margin-top: 30px;">
              The algorithm noticed your preferences and doubled down
            </p>
          </div>
        </div>
      `;
    }

    function createFilterBubbleSlide() {
      return `
        <div class="slide slide-4">
          <div class="slide-content">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <h2>Filter Bubble Intensity</h2>
            <div class="stat-large">${Math.round(wrappedStats.concentration)}%</div>
            <p class="subtitle">of your engagement went to just one topic</p>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${wrappedStats.concentration}%"></div>
            </div>
            <p style="font-size: 1.1rem; opacity: 0.8; margin-top: 30px;">
              ${wrappedStats.concentration > 60 ? 
                'You were trapped in a content bubble!' : 
                'Your content was moderately diverse'}
            </p>
          </div>
        </div>
      `;
    }
    function createVideoJourneySlide() {
  // Check if feedHistory has data
  if (!feedHistory || feedHistory.length === 0) {
    return `
      <div class="slide slide-5">
        <div class="slide-content">
          <h2>Your Content Journey</h2>
          <p class="subtitle">No video history available</p>
        </div>
      </div>
    `;
  }

  // Get specific snapshots at positions: 1st, 6th, 11th, 18th
  const positions = [0, 5, 10, 17]; // Array indices (0-based)
  const snapshots = positions
    .map(pos => feedHistory[pos])
    .filter(v => v && v.videoId); // Make sure video exists and has videoId
  
  console.log('Journey snapshots:', snapshots); // Debug log
  
  const videosHTML = snapshots.map((video, index) => {
    const videoNumber = positions[index] + 1; // Convert to 1-based number
    return `
      <div class="video-snapshot">
        <img src="https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg" alt="${video.title || 'Video'}">
        <div class="video-label">Video ${videoNumber}</div>
      </div>
    `;
  }).join('');
  
  return `
    <div class="slide slide-5">
      <div class="slide-content">
        <h2>Your Content Journey</h2>
        <p class="subtitle">See how your feed evolved</p>
        <div class="video-grid">
          ${videosHTML}
        </div>
        <p style="font-size: 1.1rem; opacity: 0.8; margin-top: 20px;">
          Notice how similar they became? That's the algorithm at work.
        </p>
      </div>
    </div>
  `;
}

    function createFutureSlide() {
      const topTag = wrappedStats.topHashtag;
      
      // Get 3 random videos that match the top hashtag and haven't been seen
      const futureVideos = [];
      
      for (let i = 0; i < 3; i++) {
        const video = getRandomVideoByHashtag(topTag);
        if (video) futureVideos.push(video);
      }
      
      // Fallback if not enough videos
      if (futureVideos.length === 0) {
        futureVideos.push(...feedHistory.slice(0, 3));
      }
      
      const videosHTML = futureVideos.map(v => `
        <div class="video-snapshot future">
          <img src="https://img.youtube.com/vi/${v.videoId}/mqdefault.jpg" alt="${v.title}">
          <div class="video-label">Recommended</div>
        </div>
      `).join('');

      return `
        <div class="slide extrapolation-slide">
          <div class="slide-content">
            <h2>Your Algorithmic Destiny</h2>
            <p>Based on your #${topTag} interest, here is what your feed looks like tomorrow:</p>
            <div class="video-grid">
              ${videosHTML}
            </div>
            <p class="warning-text">The algorithm has stopped showing you new perspectives.</p>
          </div>
        </div>
      `;
    }

    function createBiasRevealSlide() {
      const severityColor = 'white';
      return `
        <div class="slide slide-6">
          <div class="slide-content">
            <h2>Your Dominant Algorithmic Bias</h2>
            <div class="bias-card">
              <button class="outline-button" style="color: ${severityColor};">
                ${wrappedStats.dominantBias.name}
              </button>
              <div class="bias-description">
                ${wrappedStats.dominantBias.description}
              </div>
            </div>
            <p style="font-size: 1.1rem; opacity: 0.9; margin-top: 30px;">
              Algorithms optimize for engagement, not truth or diversity
            </p>
          </div>
        </div>
      `;
    }

    function createFinalSlide() {
      return `
        <div class="slide slide-7">
          <div class="slide-content">
            <h1>Now You Know</h1>
            <p class="subtitle">Algorithms shape what we see, think, and believe</p>
            <div style="margin: 40px 0; font-size: 1.2rem; line-height: 1.8;">
              <p>‚úì They create filter bubbles</p>
              <p>‚úì They exploit our psychology</p>
              <p>‚úì They optimize for addiction, not wellbeing</p>
            </div>
            <button class="cta-button" onclick="window.location.href='index.html'">
              Start Over
            </button>
            <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 40px;">
              Share this experience to raise awareness about algorithmic manipulation
            </p>
          </div>
        </div>
      `;
    }

    function showNoData() {
      const wrapper = document.getElementById('wrapper');
      wrapper.innerHTML = `
        <div class="slide slide-1">
          <div class="slide-content no-data">
            <h1>No Data Found</h1>
            <p class="subtitle">You need to complete the doomscroll simulation first</p>
            <button class="cta-button" onclick="window.location.href='index.html'">
              Start Simulation
            </button>
          </div>
        </div>
      `;
    }

    function setupKeyboardNav() {
      let currentSlide = 0;
      const slides = document.querySelectorAll('.slide');
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === ' ') {
          e.preventDefault();
          if (currentSlide < slides.length - 1) {
            currentSlide++;
            slides[currentSlide].scrollIntoView({ behavior: 'smooth' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (currentSlide > 0) {
            currentSlide--;
            slides[currentSlide].scrollIntoView({ behavior: 'smooth' });
          }
        }
      });
      
      const wrapper = document.getElementById('wrapper');
      wrapper.addEventListener('scroll', () => {
        const scrollPosition = wrapper.scrollTop;
        const slideHeight = window.innerHeight;
        currentSlide = Math.round(scrollPosition / slideHeight);
      });
    }
  </script>
</body>
</html>