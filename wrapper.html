<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Your DoomScroll Wrapped 2025</title>
  <link rel="stylesheet" href="css/wrapper.css">
  <!-- <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bulma@0.9.4/css/bulma.min.css"> -->
  
</head>
<body>
  <div class="wrapper" id="wrapper">
    <!-- Slides dynamically generated here -->
  </div>

  <script>
    // Data structures
    let engagementData = null;
    let feedHistory = null;
    let wrappedStats = {};

    // Initialize on load
    window.addEventListener('DOMContentLoaded', () => {
      loadData();
      if (engagementData && feedHistory) {
        analyzeData();
        renderSlides();
      } else {
        showNoData();
      }
    });

    function loadData() {
      try {
        engagementData = JSON.parse(localStorage.getItem('userEngagement'));
        feedHistory = JSON.parse(localStorage.getItem('feedHistory'));
        
        // Fallback to mock data for testing
        if (!engagementData || !feedHistory) {
          console.log('No data found, using mock data');
          engagementData = { funny: 15, pets: 12, news: 3, dogs: 8 };
          feedHistory = [
            { id: 1, videoId: 'UhVc3B-OQIs', title: 'Ranking The Best Slow Motion Dogs üê∂', hashtags: ['funny', 'pets', 'dogs'] },
            { id: 2, videoId: '0tng6DqwT3w', title: 'Ranking Dramatic Husky Moments üòÇ', hashtags: ['funny', 'pets', 'dogs'] }
          ];
        }
      } catch (error) {
        console.error('Error loading data:', error);
      }
    }

    function analyzeData() {
      // Calculate total engagement
      const totalEngagement = Object.values(engagementData).reduce((sum, val) => sum + val, 0);
      
      // Sort hashtags by engagement
      const sortedHashtags = Object.entries(engagementData)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 3);
      
      // Determine dominant bias based on engagement patterns
      const topHashtag = sortedHashtags[0];
      const dominantBias = determineBias(sortedHashtags, totalEngagement);
      
      // Calculate diversity score (how varied the content was)
      const diversityScore = calculateDiversity(engagementData);
      
      // Calculate engagement concentration (filter bubble intensity)
      const concentration = sortedHashtags[0][1] / totalEngagement * 100;
      
      wrappedStats = {
        totalEngagement,
        sortedHashtags,
        dominantBias,
        diversityScore,
        concentration,
        videosWatched: feedHistory.length
      };
    }

    function determineBias(hashtags, total) {
      const topPercentage = hashtags[0][1] / total * 100;
      
      if (topPercentage > 70) {
        return {
          name: 'Filter Bubble',
          description: 'The algorithm trapped you in an echo chamber, showing you mostly one type of content. This creates a narrow worldview and reinforces existing preferences.',
          severity: 'high'
        };
      } else if (topPercentage > 50) {
        return {
          name: 'Confirmation Bias',
          description: 'You were fed content that confirmed your interests, making you engage more with similar topics. This reinforces your existing beliefs and preferences.',
          severity: 'medium'
        };
      } else {
        return {
          name: 'Engagement Optimization',
          description: 'The algorithm prioritized keeping you scrolling by showing varied but engaging content, maximizing your time on the platform.',
          severity: 'medium'
        };
      }
    }

    function calculateDiversity(engagement) {
      const values = Object.values(engagement);
      const mean = values.reduce((sum, val) => sum + val, 0) / values.length;
      const variance = values.reduce((sum, val) => sum + Math.pow(val - mean, 2), 0) / values.length;
      const stdDev = Math.sqrt(variance);
      
      // Lower standard deviation = more diverse, higher = more concentrated
      return Math.max(0, Math.min(100, 100 - (stdDev * 10)));
    }

    function renderSlides() {
      const wrapper = document.getElementById('wrapper');
      
      const slides = [
        createWelcomeSlide(),
        createTotalEngagementSlide(),
        createTopHashtagsSlide(),
        createFilterBubbleSlide(),
        createVideoJourneySlide(),
        createBiasRevealSlide(),
        createFinalSlide()
      ];
      
      wrapper.innerHTML = slides.join('');
      
      // Enable keyboard navigation
      setupKeyboardNav();
    }

    function createWelcomeSlide() {
      return `
        <div class="slide slide-1">
          <div class="slide-content">
            <h1>Your DoomScroll<br>Wrapped 2025</h1>
            <p class="subtitle">Let's see how the algorithm shaped your feed...</p>
            <div class="scroll-indicator">‚Üì Scroll Down ‚Üì</div>
          </div>
        </div>
      `;
    }

    function createTotalEngagementSlide() {
      return `
        <div class="slide slide-2">
          <div class="slide-content">
            <h2>You interacted with content</h2>
            <div class="stat-large">${wrappedStats.totalEngagement}</div>
            <p class="subtitle">times across ${wrappedStats.videosWatched} videos</p>
            <p style="font-size: 1.1rem; opacity: 0.8; margin-top: 20px;">
              Each like, comment, and share taught the algorithm more about you
            </p>
          </div>
        </div>
      `;
    }

    function createTopHashtagsSlide() {
      const hashtagsHTML = wrappedStats.sortedHashtags.map((tag, index) => `
        <div class="hashtag-item">
          <span class="hashtag-name">#${tag[0]}</span>
          <span class="hashtag-score">${tag[1]} points</span>
        </div>
      `).join('');
      
      return `
        <div class="slide slide-3">
          <div class="slide-content">
            <h2>Your Top Topics</h2>
            <div class="hashtag-list">
              ${hashtagsHTML}
            </div>
            <p style="font-size: 1.1rem; opacity: 0.8; margin-top: 30px;">
              The algorithm noticed your preferences and doubled down
            </p>
          </div>
        </div>
      `;
    }

    function createFilterBubbleSlide() {
      return `
        <div class="slide slide-4">
          <div class="slide-content">
            <div class="warning-icon">‚ö†Ô∏è</div>
            <h2>Filter Bubble Intensity</h2>
            <div class="stat-large">${Math.round(wrappedStats.concentration)}%</div>
            <p class="subtitle">of your engagement went to just one topic</p>
            <div class="progress-bar">
              <div class="progress-fill" style="width: ${wrappedStats.concentration}%"></div>
            </div>
            <p style="font-size: 1.1rem; opacity: 0.8; margin-top: 30px;">
              ${wrappedStats.concentration > 60 ? 
                'You were trapped in a content bubble!' : 
                'Your content was moderately diverse'}
            </p>
          </div>
        </div>
      `;
    }

    function createVideoJourneySlide() {
      const snapshots = [
        feedHistory[0],
        feedHistory[Math.floor(feedHistory.length / 2)],
        feedHistory[feedHistory.length - 1]
      ].filter(v => v);
      
      const videosHTML = snapshots.map((video, index) => `
        <div class="video-snapshot">
          <img src="https://img.youtube.com/vi/${video.videoId}/mqdefault.jpg" alt="${video.title}">
          <div class="video-label">Video ${index === 0 ? '1' : index === 1 ? Math.floor(feedHistory.length / 2) + 1 : feedHistory.length}</div>
        </div>
      `).join('');
      
      return `
        <div class="slide slide-5">
          <div class="slide-content">
            <h2>Your Content Journey</h2>
            <p class="subtitle">See how your feed evolved</p>
            <div class="video-grid">
              ${videosHTML}
            </div>
            <p style="font-size: 1.1rem; opacity: 0.8; margin-top: 20px;">
              Notice how similar they became? That's the algorithm at work.
            </p>
          </div>
        </div>
      `;
    }

    function createBiasRevealSlide() {
      //const severityColor = wrappedStats.dominantBias.severity === 'high' ? '#ff4444' : '#ffa500';
      const severityColor = 'white';
      return `
        <div class="slide slide-6">
          <div class="slide-content">
            <h2>Your Dominant Algorithmic Bias</h2>
            <div class="bias-card">
              <button class="outline-button" style="color: ${severityColor};">
                ${wrappedStats.dominantBias.name}
              </button>
              <div class="bias-description">
                ${wrappedStats.dominantBias.description}
              </div>
            </div>
            <p style="font-size: 1.1rem; opacity: 0.9; margin-top: 30px;">
              Algorithms optimize for engagement, not truth or diversity
            </p>
          </div>
        </div>
      `;
    }

    function createFinalSlide() {
      return `
        <div class="slide slide-7">
          <div class="slide-content">
            <h1>Now You Know</h1>
            <p class="subtitle">Algorithms shape what we see, think, and believe</p>
            <div style="margin: 40px 0; font-size: 1.2rem; line-height: 1.8;">
              <p>‚úì They create filter bubbles</p>
              <p>‚úì They exploit our psychology</p>
              <p>‚úì They optimize for addiction, not wellbeing</p>
            </div>
            <button class="cta-button" onclick="window.location.href='index.html'">
              Start Over
            </button>
            <p style="font-size: 0.9rem; opacity: 0.7; margin-top: 40px;">
              Share this experience to raise awareness about algorithmic manipulation
            </p>
          </div>
        </div>
      `;
    }

    function showNoData() {
      const wrapper = document.getElementById('wrapper');
      wrapper.innerHTML = `
        <div class="slide slide-1">
          <div class="slide-content no-data">
            <h1>No Data Found</h1>
            <p class="subtitle">You need to complete the doomscroll simulation first</p>
            <button class="cta-button" onclick="window.location.href='index.html'">
              Start Simulation
            </button>
          </div>
        </div>
      `;
    }

    function setupKeyboardNav() {
      let currentSlide = 0;
      const slides = document.querySelectorAll('.slide');
      
      document.addEventListener('keydown', (e) => {
        if (e.key === 'ArrowDown' || e.key === ' ') {
          e.preventDefault();
          if (currentSlide < slides.length - 1) {
            currentSlide++;
            slides[currentSlide].scrollIntoView({ behavior: 'smooth' });
          }
        } else if (e.key === 'ArrowUp') {
          e.preventDefault();
          if (currentSlide > 0) {
            currentSlide--;
            slides[currentSlide].scrollIntoView({ behavior: 'smooth' });
          }
        }
      });
      
      // Update current slide on scroll
      const wrapper = document.getElementById('wrapper');
      wrapper.addEventListener('scroll', () => {
        const scrollPosition = wrapper.scrollTop;
        const slideHeight = window.innerHeight;
        currentSlide = Math.round(scrollPosition / slideHeight);
      });
    }
  </script>
</body>
</html>